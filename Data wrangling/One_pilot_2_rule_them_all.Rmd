---
title: "Pilot_for_infected_marc"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(anndata)
library(reticulate)
setwd("~/sc_covid_PiB2023/data_science_project/Code")
```


```{r}
# this is the infected cells
Infected <- read_h5ad("../../data/sc_covid/covid_19_virus.h5a")
```

```{r}
# this is all non-infected cells
All_data <- read_h5ad("../../data/sc_covid/COVID19_ALL.h5ad")
```

#### subsetting all data for same patients ####

```{r}
(patients_infc <- levels(Infected$obs$patients)) # all patients that has infected cells
```

```{r}
# finding the indices where PatientID is one of the patients with infected cells
Idx_patients <- which(All_data$obs$PatientID %in% patients_infc)  

# and subsetting this 
Not_All_data <- All_data[Idx_patients,]
```


```{r}
# All patientIDs match
levels(Not_All_data$obs$PatientID) == patients_infc
```


#### Celltypes n' stuff ####
```{r}
# different celltypes and amounts in the infected set
summary(Infected$obs$cellType) 
```

```{r}
# different celltypes and amounts in the non-infected set (on major type, since there are way to many celltypes)
summary(Not_All_data$obs$majorType) 
```

#### indexing ####
Since the annotation is different between `All_data` and `Infected` we will translate as follows:
annotation in `Infected` = annotation in `All_data` on celltype/majortype (in `All_data$obs$`)
Squamous  = Epi-Squamous      on celltype
Cilliated = Epi-Cilliated     on celltype
Neutrophil = Neu              on majorType
Macrophage = Macro            on majorType
NK = NK                       on majorType
Plasma = Plasma               on majorType
Secretory = Epi-Secretory     on celltype
T = CD4+CD8                   on majorType
```{r}
# finding these indices, 
Idx_squ <- which(Not_All_data$obs$celltype == 'Epi-Squamous')  # majortype Epi
Idx_cil <- which(Not_All_data$obs$celltype == 'Epi-Ciliated')  # majortype Epi
Idx_sec <- which(Not_All_data$obs$celltype == 'Epi-Secretory') # majortype Epi
Idx_neu <- which(Not_All_data$obs$majorType == 'Neu')
Idx_NK <- which(Not_All_data$obs$majorType == 'NK')
Idx_Macro <- which(Not_All_data$obs$majorType == 'Macro')
Idx_Plas <- which(Not_All_data$obs$majorType == 'Plasma')
Idx_T <- which(Not_All_data$obs$majorType %in% c('CD4', 'CD8'))

# and sampling the largest amount of (idx of) cells (such that we have equal infected/non-infected) 
squ <- sample(Idx_squ, min(length(Idx_squ), 68))
cil <- sample(Idx_cil, min(length(Idx_cil), 433))
sec <- sample(Idx_sec, min(length(Idx_sec), 565))
neu <- sample(Idx_neu, min(length(Idx_neu), 370))
NK  <- sample(Idx_NK, min(length(Idx_NK), 161))
Macro <- sample(Idx_Macro, min(length(Idx_Macro), 1107))
Plas  <- sample(Idx_Plas, min(length(Idx_Plas), 254))
T_  <- sample(Idx_T, min(length(Idx_T), 127))

# concatinating the indices and subsetting from the subsetted set
Idx <- c(squ, cil, sec, neu, NK, Macro, Plas, T_)
Non_infc_comp <- Not_All_data[Idx,]
summary(Non_infc_comp$obs$majorType) # we see that it only contains the specified major types:
```


#### writing file ####
```{r}
# We'll save this subset since the sampling was random
# Just to reiterate; this is the counterpart to the infected patients but with the healthy cells
write_h5ad(Non_infc_comp , '../Data/Non_infc_comp_same_patients.h5ad') 
```


```{r}
# we read it again for good measure
Non_infc <- read_h5ad('../Data/Non_infc_comp_same_patients.h5ad')
summary(Non_infc$obs$majorType) # same summary as above
```


#### Subsetting infected cell data?? ####
```{r}
# Problem: Not as many cells in the healthy subset as in the infected
# Two options: We could drop the cells from infected that don't have a counterpart or keep it as is -->
# We're dropping some infected cells
c(dim(Infected$X), dim(Non_infc$X))
```

```{r}
c(min(length(Idx_squ), 68), min(length(Idx_cil), 433), min(length(Idx_sec), 565),
  min(length(Idx_neu), 370), min(length(Idx_NK), 161), min(length(Idx_Macro), 1107), 
  min(length(Idx_Plas), 254), min(length(Idx_T), 127))
```

```{r}
# From the above we see only cil is a problem:
Idx_cil_infc <- which(Infected$obs$cellType == 'Ciliated')
Idx_infc <- sample(Idx_cil_infc, 433-195)
Infected_sub <- Infected[-Idx_infc,]
```

```{r}
c(dim(Infected_sub$X), dim(Non_infc$X)) # now the dimensions (cellwise) are the same
```

#### Expression matrix ####
```{r}
# we need the expression matricies as matrix objects
X_inf <- as.matrix(Infected_sub$X)
X_Non <- as.matrix(Non_infc$X)
```


```{r}
# the amount of genes so we find the ones both have in common 
Com_Col <-intersect(colnames(X_inf), colnames(X_Non))
```

```{r}
# and do a rowbind so it matches up
X <- rbind(
  subset(X_inf, select = Com_Col),
  subset(X_Non, select = Com_Col)
)
X <- as.matrix(X)
```

#### CellType ####
In this section I create a vector cellType that has the cell type of each cell translated as shown in an ealier section: 
```{r}
Nonmajortype <- list()

for (i in 1:length(Non_infc$obs$majorType))
  {
  a <- Non_infc$obs$majorType[i]  
  if (a == 'Epi'){ Nonmajortype <- append(Nonmajortype, Non_infc$obs$celltype[i])}
  else{ Nonmajortype <- append(Nonmajortype, a)}
}

```


```{r}
Nonmajortype1 <- as.character(Nonmajortype)
for (i in 1:length(Nonmajortype)){
  if (Nonmajortype1[i] == 'Epi-Squamous'){Nonmajortype1[i] = 'Squamous'}
  if (Nonmajortype1[i] == 'Epi-Ciliated'){Nonmajortype1[i] = 'Ciliated'}
  if (Nonmajortype1[i] == 'Epi-Secretory'){Nonmajortype1[i] = 'Secretory'}
  if (Nonmajortype1[i] == 'Macro'){Nonmajortype1[i] = 'Macrophage'}
  if (Nonmajortype1[i] == 'Neu'){Nonmajortype1[i] = 'Neutrophil'}
  if (Nonmajortype1[i] == 'CD4'){Nonmajortype1[i] = 'T'}
  if (Nonmajortype1[i] == 'CD8'){Nonmajortype1[i] = 'T'}
}
unique(Nonmajortype1) 
```

```{r}
cellType <- as.character(Infected_sub$obs$cellType)
cellType <- c(cellType, Nonmajortype1)
unique(cellType)
```

#### Infection load####
In this section I make a vector that describes the viral load of each cel
```{r}
length(Infected_sub$var_names)
```
```{r}
Infected_sub$var_names[23559] # located in the last column of the expression matrix
```

```{r}
virusLoad <-X_inf[,"virus"]
names(virusLoad) <- c()
head(virusLoad)
```

```{r}
any(virusLoad <= 0)
```


```{r}
zeros <- rep(0, length(virusLoad))
virusLoad <- c(virusLoad, zeros)
c(sum(virusLoad > 0), sum(virusLoad == 0))
```

#### patient_id and sample_id ####
In this section i create other usefull annotations:
```{r}
PatientID <- c(Infected_sub$obs$patients, Non_infc$obs$PatientID)
sampleID <- c(Infected_sub$obs$samples, Non_infc$obs$sampleID)
```

```{r}
c(length(PatientID),length(sampleID))
```
```{r}
#really dont know what this is, so not gonna bring it over
head(Infected_sub$obs$n_counts)
```

```{r}
# factor indicating infection
Is_infected <- factor(c(rep(1, 2847), rep(0, 2847)))
summary(Is_infected)
```

```{r}
# we want to bring over the Age variable and others which are bound to PatientID
# we make some empty vectors:
dict_sex <- c()
dict_severity <- c() 
dict_age <- c()

# For each unique id
for (person in unique(PatientID)){
  id <- sample(which(Non_infc$obs$PatientID == person), 1) # we find a row belonging to that id
  
  
  # and we pick out the annotation that we want:
  dict_sex <- append(dict_sex, Non_infc[id]$obs$Sex)
  dict_severity <- append(dict_severity, Non_infc[id]$obs$`CoVID-19 severity`)
  dict_age <- append(dict_age, Non_infc[id]$obs$Age)
}

# We then assign the annotations with the appropriate ID
names(dict_sex) <- unique(PatientID)
names(dict_severity) <- unique(PatientID)
names(dict_age) <- unique(PatientID)

# just for visual:
dict_sex
dict_severity # all critical
dict_age
```

```{r}
# we then create the vectors that will hold all the values:
Sex <- c()
severity <- c()
Age <- c()

# and loop through each sample providing the right annotation:
for (i in PatientID){
  Sex <- append(Sex, dict_sex[i])
  severity <- append(severity, dict_severity[i])
  Age <- append(Age, dict_age[i])
}
```


#### Saved as Anndata ####
```{r}
ann <- AnnData(X) # make an anndata object
```

```{r}
dim(ann$X)
```

```{r}
# add the different annotations we just created
ann$obs$cellType  <- cellType
ann$obs$viralLoad <- virusLoad
ann$obs$PatientID <- PatientID
ann$obs$sampleID  <- sampleID
ann$obs$Is_infected <- Is_infected
ann$obs$Age <- Age
ann$obs$Sex <- Sex
ann$obs$`CoVID-19 severity` <- severity
```

```{r}
# and save it!
write_h5ad(ann, '../Data/Pilot_2_rule_them_ALL.h5ad')
```

#### Some testing please ignore
```{r}
Y <- read_h5ad('../Data/Pilot_2_rule_them_ALL.h5ad')
```

```{r}
summary(Y$obs$cellType)
```

```{r}
Z <- Y[which(Y$obs$cellType == "Macrophage"),]
c(sum(Z$obs$viralLoad == 0),sum(Z$obs$viralLoad > 0))
```

